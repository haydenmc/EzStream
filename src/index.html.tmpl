<!DOCTYPE html>
<html>

  <!--
		SPDX-FileCopyrightText: 2023 The Pion community <https://pion.ly>
		SPDX-License-Identifier: MIT
	-->
  <head>
    <title>whip-whep</title>
  </head>

  <body>
    <button onclick="window.doWHEP()">Subscribe</button>
    <h3> Video </h3>
    <video id="videoPlayer" autoplay muted controls style="width: 500"> </video>


    <h3> ICE Connection States </h3>
    <div id="iceConnectionStates"></div> <br />
  </body>

  <script>
    let peerConnection = new RTCPeerConnection()

    peerConnection.oniceconnectionstatechange = () => {
      let el = document.createElement('p')
      el.appendChild(document.createTextNode(peerConnection.iceConnectionState))

      document.getElementById('iceConnectionStates').appendChild(el);
    }

    window.doWHEP = () => {
      peerConnection.addTransceiver('video', { direction: 'recvonly' })
      peerConnection.addTransceiver('audio', { direction: 'recvonly' })

      let inboundStream = null;
      peerConnection.ontrack = (event) => {
        if (!inboundStream) {
            inboundStream = new MediaStream();
            document.getElementById('videoPlayer').srcObject = inboundStream;
        }
        inboundStream.addTrack(event.track);
      }

      peerConnection.createOffer().then(offer => {
        peerConnection.setLocalDescription(offer)

        fetch(`/whep/1`, {
          method: 'POST',
          body: offer.sdp,
          headers: {
            Authorization: `Bearer none`,
            'Content-Type': 'application/sdp'
          }
        }).then(r => r.text())
          .then(answer => {
            peerConnection.setRemoteDescription({
              sdp: answer,
              type: 'answer'
            })
          })
      })
    }
  </script>
</html>